{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-2">
                    <i class="bi bi-graph-up text-success me-2"></i>
                    {{ vital }}
                </h1>
                <p class="text-muted mb-0">
                    {{ category }} measurement data and trends
                </p>
            </div>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="exportData('csv')">
                    <i class="bi bi-download me-1"></i>
                    Export CSV
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="exportData('json')">
                    <i class="bi bi-download me-1"></i>
                    Export JSON
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Controls Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="bi bi-sliders me-2"></i>
                    Filter Options
                </h6>
                <form id="filterForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="dateAfter" class="form-label">After Date</label>
                            <input type="date" class="form-control" id="dateAfter" name="after">
                        </div>
                        <div class="col-md-6">
                            <label for="dateBefore" class="form-label">Before Date</label>
                            <input type="date" class="form-control" id="dateBefore" name="before">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-funnel me-1"></i>
                                Apply Filters
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-1"></i>
                                Clear
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="bi bi-bar-chart me-2"></i>
                    Summary Statistics
                </h6>
                <div id="summaryStats">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>
                    {{ vital }} Trends
                </h5>
            </div>
            <div class="card-body">
                <div id="chartContainer" style="width: 100%; height: 400px;">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading chart...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Table Row -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-table me-2"></i>
                    Data Points
                </h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showAllData">
                    <label class="form-check-label" for="showAllData">
                        Show all data
                    </label>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="dataTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Value</th>
                                <th>Unit</th>
                                <th>Measurement</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading data...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <nav aria-label="Data pagination" id="paginationNav" style="display: none;">
                    <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentData = [];
let filteredData = [];
let chart = null;
const itemsPerPage = 50;
let currentPage = 1;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    
    // Filter form submission
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loadData();
    });
    
    // Show all data toggle
    document.getElementById('showAllData').addEventListener('change', function() {
        updateDataTable();
    });
});

function loadData() {
    const formData = new FormData(document.getElementById('filterForm'));
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
        if (value) params.append(key, value);
    }
    
    const apiUrl = '/api' + window.location.pathname + '/data?' + params.toString();
    
    // Show loading states
    showChartLoading();
    showTableLoading();
    showStatsLoading();
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            console.log('API Response:', data); // Debug log
            currentData = data;
            filteredData = data.data ? [...data.data] : [];
            
            updateChart();
            updateDataTable();
            updateSummaryStats();
        })
        .catch(error => {
            console.error('Error loading data:', error);
            showError('Failed to load data: ' + error.message);
        });
}

function showChartLoading() {
    document.getElementById('chartContainer').innerHTML = `
        <div class="d-flex justify-content-center align-items-center h-100">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading chart...</span>
            </div>
        </div>
    `;
}

function showTableLoading() {
    document.getElementById('dataTableBody').innerHTML = `
        <tr>
            <td colspan="5" class="text-center">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading data...</span>
                </div>
            </td>
        </tr>
    `;
}

function showStatsLoading() {
    document.getElementById('summaryStats').innerHTML = `
        <div class="d-flex justify-content-center">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
}

function updateChart() {
    // Get filter parameters from the form
    const formData = new FormData(document.getElementById('filterForm'));
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
        if (value) params.append(key, value);
    }
    
    const chartUrl = '/api' + window.location.pathname + '/chart?' + params.toString();
    
    console.log('Fetching chart from:', chartUrl); // Debug log
    
    fetch(chartUrl)
        .then(response => {
            console.log('Chart response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(chartData => {
            console.log('Chart data received:', chartData); // Debug log
            console.log('Chart data keys:', Object.keys(chartData));
            
            const chartContainer = document.getElementById('chartContainer');
            
            // Properly dispose of existing chart instance BEFORE clearing container
            if (chart) {
                try {
                    chart.dispose();
                    console.log('Existing chart disposed');
                } catch (e) {
                    console.log('Error disposing chart (might be already disposed):', e);
                }
                chart = null;
            }
            
            chartContainer.innerHTML = '';
            
            // Check if ECharts is available
            if (typeof echarts === 'undefined') {
                throw new Error('ECharts library is not loaded');
            }
            
            // Validate chart config exists
            if (!chartData.chart_config) {
                throw new Error('No chart configuration received');
            }
            
            console.log('Chart config keys:', Object.keys(chartData.chart_config));
            console.log('Chart config:', JSON.stringify(chartData.chart_config, null, 2));
            
            // Check series data
            if (chartData.series && chartData.series.length > 0) {
                chartData.series.forEach((series, index) => {
                    console.log(`Series ${index} (${series.name}): ${series.data.length} data points`);
                    if (series.data.length > 0) {
                        console.log(`  First point:`, series.data[0]);
                        console.log(`  Last point:`, series.data[series.data.length - 1]);
                    }
                });
            }
            
            chart = echarts.init(chartContainer);
            console.log('New ECharts instance created');
            
            chart.setOption(chartData.chart_config);
            console.log('Chart options set successfully');
            
            // Force chart to resize and render
            setTimeout(() => {
                chart.resize();
                console.log('Chart resized');
                console.log('Chart container dimensions:', chartContainer.offsetWidth + 'x' + chartContainer.offsetHeight);
            }, 100);
            
            // Make chart responsive
            window.addEventListener('resize', function() {
                if (chart) {
                    chart.resize();
                }
            });
        })
        .catch(error => {
            console.error('Chart error:', error); // Debug log
            document.getElementById('chartContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading chart: ${error.message}
                </div>
            `;
        });
}

function updateDataTable() {
    const showAll = document.getElementById('showAllData').checked;
    const dataToShow = showAll ? filteredData : filteredData.slice(0, itemsPerPage);
    
    const tbody = document.getElementById('dataTableBody');
    
    if (dataToShow.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <i class="bi bi-info-circle me-2"></i>
                    No data points found
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    dataToShow.forEach(point => {
        const date = new Date(point.date);
        const dateStr = date.toLocaleDateString();
        const timeStr = date.toLocaleTimeString();
        
        // Handle both numeric and text values
        const valueDisplay = point.is_text 
            ? `<div style="max-width: 300px; word-wrap: break-word; white-space: pre-wrap;">${point.text_value}</div>`
            : `<strong>${point.value}</strong>`;
        const unitDisplay = point.unit || '';
        
        html += `
            <tr>
                <td>${dateStr}</td>
                <td>${timeStr}</td>
                <td>${valueDisplay}</td>
                <td>${unitDisplay}</td>
                <td>${point.name}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // Show pagination if needed and not showing all
    if (!showAll && filteredData.length > itemsPerPage) {
        setupPagination();
        document.getElementById('paginationNav').style.display = 'block';
    } else {
        document.getElementById('paginationNav').style.display = 'none';
    }
}

function setupPagination() {
    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    
    let html = '';
    
    // Previous button
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
        </li>
    `;
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }
    
    // Next button
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
        </li>
    `;
    
    pagination.innerHTML = html;
}

function changePage(page) {
    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    updateDataTable();
}

function updateSummaryStats() {
    console.log('updateSummaryStats called, filteredData:', filteredData); // Debug log
    
    if (!filteredData || !Array.isArray(filteredData) || filteredData.length === 0) {
        document.getElementById('summaryStats').innerHTML = `
            <p class="text-muted mb-0">No data available for statistics</p>
        `;
        return;
    }
    
    // Group data by measurement name (e.g., "Systolic Blood Pressure", "Diastolic Blood Pressure")
    const dataByName = {};
    filteredData.forEach(point => {
        if (!dataByName[point.name]) {
            dataByName[point.name] = [];
        }
        dataByName[point.name].push(point);
    });
    
    const dataNames = Object.keys(dataByName);
    let statsHtml = '';
    
    // Create statistics for each data type
    dataNames.forEach((name, index) => {
        const points = dataByName[name];
        const isTextBased = points[0]?.is_text || false;
        
        if (isTextBased) {
            // For text-based results, just show count
            const count = points.length;
            const marginClass = index > 0 ? 'mt-4' : '';
            
            statsHtml += `
                <div class="${marginClass}">
                    <h6 class="text-primary mb-3">${name}</h6>
                    <div class="row text-center">
                        <div class="col-12">
                            <div>
                                <h6 class="text-primary mb-1">${count}</h6>
                                <small class="text-muted">Total Results</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Text-based results - see data table for details</small>
                    </div>
                </div>
            `;
        } else {
            // For numeric results, calculate statistics
            const values = points.map(point => point.value);
            const count = values.length;
            const sum = values.reduce((a, b) => a + b, 0);
            const avg = sum / count;
            const min = Math.min(...values);
            const max = Math.max(...values);
            const unit = points[0]?.unit || '';
            
            // Add margin between datasets for multi-dataset vitals
            const marginClass = index > 0 ? 'mt-4' : '';
            
            statsHtml += `
                <div class="${marginClass}">
                    <h6 class="text-primary mb-3">${name}</h6>
                    <div class="row text-center">
                        <div class="col-6 col-md-3">
                            <div class="border-end">
                                <h6 class="text-primary mb-1">${count}</h6>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="border-end">
                                <h6 class="text-success mb-1">${avg.toFixed(2)} ${unit}</h6>
                                <small class="text-muted">Average</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="border-end">
                                <h6 class="text-danger mb-1">${min} ${unit}</h6>
                                <small class="text-muted">Minimum</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div>
                                <h6 class="text-warning mb-1">${max} ${unit}</h6>
                                <small class="text-muted">Maximum</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    document.getElementById('summaryStats').innerHTML = statsHtml;
}

function clearFilters() {
    document.getElementById('filterForm').reset();
    loadData();
}

function exportData(format) {
    const formData = new FormData(document.getElementById('filterForm'));
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
        if (value) params.append(key, value);
    }
    
    params.append('format', format);
    
    const exportUrl = window.location.pathname + '/data?' + params.toString();
    
    // Create temporary link and trigger download
    const link = document.createElement('a');
    link.href = exportUrl;
    link.download = `{{ vital|replace(' ', '_') }}_data.${format}`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function showError(message) {
    const chartContainer = document.getElementById('chartContainer');
    chartContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}
</script>
{% endblock %}